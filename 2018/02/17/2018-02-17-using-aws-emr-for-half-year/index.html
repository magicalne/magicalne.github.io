<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="瞎bb的私密小天地，羞"><title>半年aws emr有感 | 做正确的事</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Lato"></head><body><!-- gallery that comes before the header--><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a><a href="/about" class="sidebar-nav-item">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/AWS/">AWS</a><a class="post-tag-link" href="/tags/EMR/">EMR</a></div><div class="post-time">2018-02-17</div></div></div><div class="container post-header"><h1>半年aws emr有感</h1></div><div class="container post-content"><p>2017年6月末加入新公司，开始了一段startup之旅。核心技术自然是aws:)</p>
<p>我负责一个线上服务，后面拓展到了3个线上服务+一个hbase集群。多亏aws，我一个人就能hold住，几乎。</p>
<h3 id="EMR"><a href="#EMR" class="headerlink" title="EMR"></a>EMR</h3><p>因为主要工作内容跟data pipeline有关，所以EMR用的更多些。一开始并不是很理解EMR的设计，踩过几次坑之后，也就明白了。</p>
<p>EMR的核心思想是把存储和计算分离。</p>
<p>传统的技术架构，计算和存储耦合在一起其实也没什么问题。比如从主库抽数据到data warehouse，再在比如spark／hive上做计算。但是这里的问题就是，这个data warehuose必须一直online。当然对于大公司这没什么问题。但是对于一个小公司，只有一个人用，平常可能一星期才跑一次spark，如果一直online是很贵的。</p>
<p>所以EMR的玩法就是，所有的数据都放在S3或者Dynamodb上，当然AWS自己的其他基础设施也行。S3最适合我们的情况。计算就用spark或者hive。hive就用作导表，spark用于具体计算。hbase集群也是依托于S3的。</p>
<h3 id="EMR-HBase-on-S3"><a href="#EMR-HBase-on-S3" class="headerlink" title="EMR-HBase on S3"></a>EMR-HBase on S3</h3><p>顺便一说，如果在生产环境下用hbase，一定要用on S3的模式，也就是存储是S3。而且要启动consistent view。这个consistent view用于集群和s3之间的一致性问题。怎么解决的呢？一致性用dynamodb再存一次咯。当然这里的dynamodb我们是访问不到的。</p>
<p>如果不用on s3模式，那就是一个玩具，随时会崩。虽然我无从得知具体的实现细节，但是可以猜测。hadoop那层还是要用hdfs的。而这层hdfs是在emrfs上面的。emrfs你是碰不到的，如果出现不一致的情况，只能让它崩溃了。这也就是consistent view存在的原因。</p>
<p>on S3的模式就不需要再像hdfs那样存3份了。hbase cluster会从s3 dir上读。实践下来还是有坑的。一致性的问题还是会有。不过稳定很多。</p>
<p>另外，hbase on s3就不再需要snapshot了，s3就是天然的snapshot。而且还可以加入replication cluster。但是这个replication是有损的。如果你用了phoenix on hbase，那么phoenix没法在replication上工作。我发现replication的实现方式是新增hbase:meta-cluster_id表。我记得hbase:meta这个表在master启动时会用到的，所以应该不是客户端配置的，通过修改指定hbase:meta表的方式，emr可以让你在只有一个s3 dir的情况下，为replication共享。用这种隔离系统表的方式，隔离replica。</p>
<h3 id="Data-pipeline"><a href="#Data-pipeline" class="headerlink" title="Data pipeline"></a>Data pipeline</h3><p>我所有的data pipeline都是围绕hbase的。入口处还有几个postgresql上主站的表。</p>
<p>不得不吐槽，hbase和phoenix对spark的支持真是差到家了。。。导表还是hive好，可以直接把hbase的表导到s3。postgresql的表是用spark导的。最后用spark sql跑计算，并把结果写回S3。</p>
<p>spot instance是个好东西，可以省不少钱。</p>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>