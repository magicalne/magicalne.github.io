<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="瞎bb的私密小天地，羞"><title>基于QUIC的透明代理客户端优化 | 做正确的事</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Lato"><meta name="generator" content="Hexo 4.2.1"></head><body><!-- gallery that comes before the header--><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a><a href="/about" class="sidebar-nav-item">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/proxy/" rel="tag">proxy</a><a class="post-tag-link" href="/tags/quinn/" rel="tag">quinn</a><a class="post-tag-link" href="/tags/rust/" rel="tag">rust</a></div><div class="post-time">2020-08-19</div></div></div><div class="container post-header"><h1>基于QUIC的透明代理客户端优化</h1></div><div class="container post-content"><p>在基本功能完善之后，发现代理速度如龟。这跟理论不贴合阿，先从client入手。</p>
<p>第一个问题非常明显，client的udp连接没有做到复用。QUIC是支持单udp socket上建立多connection。而我在实现的时候是把每个tcp连接代理出去的时候就建立一个udp连接。这里改成向future传入&amp;Endpoint就好了。</p>
<p>但是改完之后还是好慢，没有任何改善。</p>
<p>我开始打开trace log，观察twitter首页的加载。一段在http1.1的传过来js，只有～140kb，居然要用10多秒。而log显示每次recv都只有30-40字节，都不是kb…本地代理出去的时间很快，不到1ms，关键就是waiting(TTFB)的时间有点久了，下载速度是肉眼可见的慢，但是还是在下载的，没有断掉。</p>
<p>quinn文档有说到，遇到延迟特别大的时候可以考虑调整SO_SNDBUF and SO_RCVBUF，我一直以为这两个参数值的是我的应用层的buffer size。后来才想到这个可能是操作系统层面的参数。</p>
<p>在我的fedora运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sysctl net.core.rmem_max</span></span><br><span class="line">net.core.rmem_max = 212992</span><br><span class="line"><span class="meta">$</span><span class="bash"> sysctl net.core.rmem_default</span></span><br><span class="line">net.core.rmem_default = 212992</span><br></pre></td></tr></table></figure>
<p>也就是说最大不过208kb？改成25M试试:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo sysctl -w net.core.rmem_max=26214400</span></span><br><span class="line">net.core.rmem_max = 26214400</span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo sysctl -w net.core.rmem_default=26214400</span></span><br><span class="line">net.core.rmem_default = 26214400</span><br></pre></td></tr></table></figure>
<p>速度飞起，心疼流量…</p>
<p>目测+心算，http1.1下应该是**ray的10倍吧。youtube视频4k随便拖拽～～</p>
<p>之所以想自己写代理的原因，就是在看youtube的时候突然卡掉了，telnet却是通的。等youtube缓冲半天，进度条还是纹丝不动，看看telnet还是通的！</p>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>